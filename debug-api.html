<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯• Luma API è°ƒç”¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Luma API è°ƒè¯•å·¥å…·</h1>
        
        <div class="test-section">
            <h3>1. è·å–è®¤è¯ä¿¡æ¯</h3>
            <button onclick="testAuth()">ğŸª æµ‹è¯•è®¤è¯Cookie</button>
            <div id="auth-output" class="output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. æµ‹è¯•äº‹ä»¶åˆ—è¡¨API</h3>
            <button onclick="testEventsList()">ğŸ“‹ è·å–äº‹ä»¶åˆ—è¡¨</button>
            <div id="events-output" class="output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•è®¿å®¢æ•°æ®API</h3>
            <div class="input-group">
                <label>äº‹ä»¶API ID:</label>
                <input type="text" id="event-api-id" placeholder="è¾“å…¥äº‹ä»¶çš„api_idï¼Œä¾‹å¦‚: evt-xxxxxxxxxxxx">
            </div>
            <button onclick="testGuestList()">ğŸ‘¥ è·å–è®¿å®¢æ•°æ®</button>
            <div id="guests-output" class="output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. æµ‹è¯•å®Œæ•´æŠ“å–æµç¨‹</h3>
            <div class="input-group">
                <label>äº‹ä»¶API ID:</label>
                <input type="text" id="full-event-api-id" placeholder="è¾“å…¥äº‹ä»¶çš„api_id">
            </div>
            <button onclick="testFullScraping()">ğŸš€ å®Œæ•´æŠ“å–æµ‹è¯•</button>
            <button onclick="stopTest()">â¹ï¸ åœæ­¢æµ‹è¯•</button>
            <div id="full-output" class="output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. æ§åˆ¶å°è¾“å‡º</h3>
            <button onclick="clearConsole()">ğŸ—‘ï¸ æ¸…é™¤è¾“å‡º</button>
            <button onclick="exportLogs()">ğŸ“ å¯¼å‡ºæ—¥å¿—</button>
            <div id="console-output" class="output"></div>
        </div>
    </div>

    <script>
        let testRunning = false;
        let logBuffer = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logBuffer.push(logMessage);
            
            const output = document.getElementById('console-output');
            output.textContent += logMessage + '\n';
            output.scrollTop = output.scrollHeight;
            
            console.log(message);
        }

        function clearConsole() {
            document.getElementById('console-output').textContent = '';
            logBuffer = [];
        }

        function exportLogs() {
            const content = logBuffer.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `luma_debug_${new Date().toISOString().split('T')[0]}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function testAuth() {
            const output = document.getElementById('auth-output');
            output.style.display = 'block';
            output.textContent = 'æ­£åœ¨æµ‹è¯•è®¤è¯...\n';

            try {
                if (!chrome?.runtime?.sendMessage) {
                    throw new Error('Chromeæ‰©å±•APIä¸å¯ç”¨');
                }

                const response = await chrome.runtime.sendMessage({ action: 'getCookies' });
                
                if (response.success) {
                    const result = `âœ… è®¤è¯æˆåŠŸ
ğŸ“‹ Cookieä¿¡æ¯:
  - åŸŸå: ${response.authCookie.domain}
  - å€¼é•¿åº¦: ${response.authValue.length} å­—ç¬¦
  - è¿‡æœŸæ—¶é—´: ${response.authCookie.expirationDate ? new Date(response.authCookie.expirationDate * 1000).toLocaleString() : 'ä¼šè¯ç»“æŸæ—¶'}
  - å®‰å…¨: ${response.authCookie.secure ? 'æ˜¯' : 'å¦'}
  - HttpOnly: ${response.authCookie.httpOnly ? 'æ˜¯' : 'å¦'}

ğŸ”‘ Cookie Header:
${response.cookieHeader.substring(0, 200)}...`;
                    
                    output.textContent = result;
                    log('âœ… è®¤è¯æµ‹è¯•æˆåŠŸ');
                } else {
                    output.textContent = `âŒ è®¤è¯å¤±è´¥: ${response.error}`;
                    log('âŒ è®¤è¯æµ‹è¯•å¤±è´¥: ' + response.error);
                }
            } catch (error) {
                output.textContent = `âŒ é”™è¯¯: ${error.message}`;
                log('âŒ è®¤è¯æµ‹è¯•é”™è¯¯: ' + error.message);
            }
        }

        async function testEventsList() {
            const output = document.getElementById('events-output');
            output.style.display = 'block';
            output.textContent = 'æ­£åœ¨è·å–äº‹ä»¶åˆ—è¡¨...\n';

            try {
                const cookieResponse = await chrome.runtime.sendMessage({ action: 'getCookies' });
                
                if (!cookieResponse.success) {
                    throw new Error('æ— æ³•è·å–è®¤è¯Cookie: ' + cookieResponse.error);
                }

                const apiUrl = 'https://api2.luma.com/search/get-results?query=';
                const headers = {
                    'accept': '*/*',
                    'accept-language': 'zh',
                    'cookie': cookieResponse.cookieHeader,
                    'origin': 'https://luma.com',
                    'referer': 'https://luma.com/',
                    'x-luma-client-type': 'luma-web',
                    'x-luma-web-url': 'https://luma.com/home'
                };

                log('ğŸ“¡ è°ƒç”¨äº‹ä»¶åˆ—è¡¨API...');
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                const result = `âœ… äº‹ä»¶åˆ—è¡¨è·å–æˆåŠŸ
ğŸ“Š å“åº”ç»Ÿè®¡:
  - æ€»äº‹ä»¶æ•°: ${data.events ? data.events.length : 0}
  - æœ‰è®¿é—®æƒé™: ${data.events ? data.events.filter(e => e.virtual_info?.has_access).length : 0}
  - å¯æŠ“å–äº‹ä»¶: ${data.events ? data.events.filter(e => e.show_guest_list && e.virtual_info?.has_access).length : 0}

ğŸ“‹ äº‹ä»¶è¯¦æƒ…:
${data.events ? data.events.slice(0, 3).map((event, i) => `
äº‹ä»¶ ${i + 1}: ${event.name}
  - API ID: ${event.api_id}
  - URL: https://lu.ma/${event.url}
  - è®¿å®¢åˆ—è¡¨å¯è§: ${event.show_guest_list ? 'âœ…' : 'âŒ'}
  - æœ‰è®¿é—®æƒé™: ${event.virtual_info?.has_access ? 'âœ…' : 'âŒ'}
  - å¯æŠ“å–: ${event.show_guest_list && event.virtual_info?.has_access ? 'âœ…' : 'âŒ'}
`).join('') : 'æ— äº‹ä»¶æ•°æ®'}

ğŸ“„ å®Œæ•´å“åº”æ•°æ®:
${JSON.stringify(data, null, 2)}`;

                output.textContent = result;
                log('âœ… äº‹ä»¶åˆ—è¡¨æµ‹è¯•æˆåŠŸï¼Œæ‰¾åˆ° ' + (data.events ? data.events.length : 0) + ' ä¸ªäº‹ä»¶');

            } catch (error) {
                output.textContent = `âŒ é”™è¯¯: ${error.message}`;
                log('âŒ äº‹ä»¶åˆ—è¡¨æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        async function testGuestList() {
            const eventApiId = document.getElementById('event-api-id').value.trim();
            if (!eventApiId) {
                alert('è¯·è¾“å…¥äº‹ä»¶API ID');
                return;
            }

            const output = document.getElementById('guests-output');
            output.style.display = 'block';
            output.textContent = `æ­£åœ¨è·å–äº‹ä»¶ ${eventApiId} çš„è®¿å®¢æ•°æ®...\n`;

            try {
                const cookieResponse = await chrome.runtime.sendMessage({ action: 'getCookies' });
                
                if (!cookieResponse.success) {
                    throw new Error('æ— æ³•è·å–è®¤è¯Cookie: ' + cookieResponse.error);
                }

                const apiUrl = new URL('https://api2.luma.com/event/get-guest-list');
                apiUrl.searchParams.set('event_api_id', eventApiId);
                apiUrl.searchParams.set('pagination_limit', '100');

                const headers = {
                    'accept': 'application/json',
                    'accept-language': 'zh',
                    'cookie': cookieResponse.cookieHeader,
                    'origin': 'https://luma.com',
                    'referer': 'https://luma.com/',
                    'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
                    'x-luma-client-type': 'luma-web',
                    'x-luma-web-url': 'https://luma.com/home'
                };

                log(`ğŸ“¡ è°ƒç”¨è®¿å®¢API: ${apiUrl.toString()}`);
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });

                log(`ğŸ“¡ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}\nå“åº”å†…å®¹: ${errorText}`);
                }

                const data = await response.json();
                
                // åˆ†ææ•°æ®ç»“æ„
                const analysis = {
                    hasEntries: !!data.entries,
                    entriesLength: Array.isArray(data.entries) ? data.entries.length : 'not array',
                    hasGuests: !!data.guests,
                    guestsLength: Array.isArray(data.guests) ? data.guests.length : 'not array',
                    hasData: !!data.data,
                    dataLength: Array.isArray(data.data) ? data.data.length : 'not array',
                    allKeys: Object.keys(data),
                    cursor: data.next_cursor || data.pagination_cursor || data.cursor,
                    totalPages: data.total_pages,
                    hasNextPage: data.has_next_page
                };

                const result = `âœ… è®¿å®¢æ•°æ®è·å–${response.ok ? 'æˆåŠŸ' : 'å¤±è´¥'}
ğŸ“Š æ•°æ®ç»“æ„åˆ†æ:
${JSON.stringify(analysis, null, 2)}

ğŸ” åŸå§‹å“åº”:
${JSON.stringify(data, null, 2)}`;

                output.textContent = result;
                log(`âœ… è®¿å®¢æ•°æ®æµ‹è¯•å®Œæˆ`);

            } catch (error) {
                output.textContent = `âŒ é”™è¯¯: ${error.message}`;
                log('âŒ è®¿å®¢æ•°æ®æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        async function testFullScraping() {
            const eventApiId = document.getElementById('full-event-api-id').value.trim();
            if (!eventApiId) {
                alert('è¯·è¾“å…¥äº‹ä»¶API ID');
                return;
            }

            const output = document.getElementById('full-output');
            output.style.display = 'block';
            output.textContent = `å¼€å§‹å®Œæ•´æŠ“å–æµ‹è¯•...\näº‹ä»¶ID: ${eventApiId}\n\n`;

            testRunning = true;
            let allVisitors = [];
            let cursor = null;
            let page = 0;

            try {
                const cookieResponse = await chrome.runtime.sendMessage({ action: 'getCookies' });
                
                if (!cookieResponse.success) {
                    throw new Error('æ— æ³•è·å–è®¤è¯Cookie');
                }

                while (testRunning && page < 10) { // æœ€å¤š10é¡µ
                    page++;
                    output.textContent += `\nğŸ“„ æŠ“å–ç¬¬ ${page} é¡µ...\n`;

                    const apiUrl = new URL('https://api2.luma.com/event/get-guest-list');
                    apiUrl.searchParams.set('event_api_id', eventApiId);
                    apiUrl.searchParams.set('pagination_limit', '100');
                    
                    if (cursor) {
                        apiUrl.searchParams.set('pagination_cursor', cursor);
                    }

                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'accept': 'application/json',
                            'cookie': cookieResponse.cookieHeader,
                            'origin': 'https://luma.com',
                            'referer': 'https://luma.com/',
                            'x-luma-client-type': 'luma-web'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`ç¬¬${page}é¡µè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // å¤„ç†æ•°æ®
                    let pageVisitors = [];
                    const rawEntries = data.entries || data.guests || data.data || [];
                    
                    if (rawEntries.length > 0) {
                        pageVisitors = rawEntries.map(entry => {
                            const user = entry.user || entry.guest || entry;
                            return user.api_id ? {
                                api_id: user.api_id,
                                name: user.name,
                                username: user.username
                            } : null;
                        }).filter(v => v);
                    }

                    allVisitors = [...allVisitors, ...pageVisitors];
                    output.textContent += `  âœ… ç¬¬${page}é¡µå®Œæˆï¼Œè·å–${pageVisitors.length}æ¡æ•°æ®ï¼Œç´¯è®¡${allVisitors.length}æ¡\n`;

                    cursor = data.next_cursor || data.pagination_cursor || data.cursor;
                    
                    if (!cursor || pageVisitors.length === 0) {
                        output.textContent += `\nğŸ‰ æŠ“å–å®Œæˆï¼\næ€»è®¡: ${allVisitors.length} æ¡è®¿å®¢æ•°æ®\n`;
                        break;
                    }

                    // å»¶è¿Ÿ3ç§’
                    output.textContent += `  â±ï¸ ç­‰å¾…3ç§’...\n`;
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }

                log(`ğŸ‰ å®Œæ•´æŠ“å–æµ‹è¯•å®Œæˆï¼Œå…±è·å– ${allVisitors.length} æ¡æ•°æ®`);

            } catch (error) {
                output.textContent += `\nâŒ é”™è¯¯: ${error.message}\n`;
                log('âŒ å®Œæ•´æŠ“å–æµ‹è¯•å¤±è´¥: ' + error.message);
            } finally {
                testRunning = false;
            }
        }

        function stopTest() {
            testRunning = false;
            log('â¹ï¸ æµ‹è¯•å·²åœæ­¢');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸš€ Luma API è°ƒè¯•å·¥å…·å·²å¯åŠ¨');
            
            // æ£€æŸ¥æ‰©å±•æ˜¯å¦å¯ç”¨
            if (!chrome?.runtime?.sendMessage) {
                log('âš ï¸ Chromeæ‰©å±•APIä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿æ’ä»¶å·²å®‰è£…å¹¶å¯ç”¨');
            } else {
                log('âœ… Chromeæ‰©å±•APIå¯ç”¨');
            }
        });
    </script>
</body>
</html>